# TCP拥塞控制

## 1、定义

网络拥塞：当一段时间内网络管道中的资源需求超过了可用，导致网络性能下降的情况就是拥塞。

拥塞控制：防止过多的数据注入到网络中，这样可以防止网络中的路由器或链路不至于过载。拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷。拥塞控制是一个全局性的过程，涉及到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。

流量控制：往往指点对点通信量的控制，是个端到端的问题。流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收。



## 2、为什么拥塞控制

拥塞控制是为了防止网络性能下降，也就是防止网络传输中出现瘫痪或者大量丢弃数据包。网络中的路由器会有一个数据包处理队列，当路由器中接收到的数据包太多而无法继续处理新的包，就会把新接收到的数据包直接丢弃。

这样会导致上层的TCP协议以为数据包意外丢失，而不断重传这些数据包，而路由器继续丢弃。这样会持续占用网络传输的资源，进而引起网络瘫痪。



## 3、拥塞控制算法总结

慢开始（slow-start）、拥塞避免（congestion avoidance）、快重传（fast retransmit）、快恢复（fast recovery）



## 4、慢开始算法

首先发送端设置一个变量cwnd(congestion window)作为拥塞窗口，拥塞窗口的大小根据测量的网络拥塞程度而动态地变化。这里控制拥塞窗口的原则是只要网络能够负荷就继续增大，遇到拥塞（丢包）就相应地减小。

慢开始，就是一开始例如先传一个数据包，得到ack消息确认后，下一次逐步增多数据包直到首次出现拥塞（丢包）。这里每经过一个传输轮次，cwnd就加倍。

传输轮次：把拥塞窗口cwnd所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认。

![1586669025046](C:\Users\wonde\AppData\Roaming\Typora\typora-user-images\1586669025046.png)

慢开始的“慢”并不是指cwnd的增长速率慢，而是指在TCP开始发送报文段时先设置cwnd=1，使得发送方在开始时只发送一个报文段（目的是试探一下网络的拥塞情况），然后再逐渐增大cwnd。

为了防止某次增大cwnd突然超出网络负荷，这里还有一个慢开始门限ssthresh状态变量：

    当 cwnd < ssthresh 时，使用上述的慢开始算法。
    
    当 cwnd > ssthresh 时，停止使用慢开始算法而改用拥塞避免算法。
    
    当 cwnd = ssthresh 时，既可使用慢开始算法，也可使用拥塞控制避免算法。


## 5、拥塞避免算法

让拥塞窗口cwnd缓慢地增大，每经过一个时间轮次就把发送方cwnd加1，而不是慢开始的加倍。这样cwnd线性地增长，不至于某次增加就突然造成网络拥塞。

如何设置ssthresh: 无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有收到确认），就要把慢开始门限ssthresh设置为出现拥塞时的发送方窗口值的一半（但不能小于2）。

然后把拥塞窗口cwnd重新设置为1，执行慢开始算法。这样做的目的就是要迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕。



## 6、慢开始加拥塞避免

这里用图例的具体数值说明了上述拥塞控制的过程。现在发送窗口的大小和拥塞窗口一样大。

<1>. 当TCP连接进行初始化时，把拥塞窗口cwnd置为1。前面已说过，为了便于理解，图中的窗口单位不使用字节而使用报文段的个数。慢开始门限的初始值设置为16个报文段，即 cwnd = 16 。

<2>. 在执行慢开始算法时，拥塞窗口 cwnd 的初始值为1。以后发送方每收到一个对新报文段的确认ACK，就把拥塞窗口值另1，然后开始下一轮的传输（图中横坐标为传输轮次）。因此拥塞窗口cwnd随着传输轮次按指数规律增长。当拥塞窗口cwnd增长到慢开始门限值ssthresh时（即当cwnd=16时），就改为执行拥塞控制算法，拥塞窗口按线性规律增长。

<3>. 假定拥塞窗口的数值增长到24时，网络出现超时（这很可能就是网络发生拥塞了）。更新后的ssthresh值变为12（即变为出现超时时的拥塞窗口数值24的一半），拥塞窗口再重新设置为1，并执行慢开始算法。当cwnd=ssthresh=12时改为执行拥塞避免算法，拥塞窗口按线性规律增长，每经过一个往返时间增加一个MSS的大小。

需要注意的是，“拥塞避免”并非指完全能够避免了拥塞。利用以上的措施要完全避免网络拥塞还是不可能的，“拥塞避免”是说在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞。

![1586669636705](C:\Users\wonde\AppData\Roaming\Typora\typora-user-images\1586669636705.png)

## 7、快重传算法

TCP 的可靠传输的原理是超时重传机制。配合上面的慢开始和拥塞避免使用就是发送发发送完数据后设置一个定时器，如果在定时器时间内没有收到对接收方发来的确认的话就去执行上述的乘法减小过程并重新开始慢开始算法。

而快重传则是允许发送方再连续收到 3 个重复的确认后就可以开始执行乘法减小过程而不必再等待所设置的重传计时器到时。这就需要接收方没收到一个失序的报文段就立即发出重复确认以让发送发及早知道有报文段丢失，而不是等待自己发送数据的时候进行捎带确认。

![img](https://img-blog.csdn.net/20140509221032109?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWVjaGFvZGVjaHVudGlhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

上图中，接收方收到了M1和M2后都分别发出了确认。现在假定接收方没有收到M3但接着收到了M4。显然，接收方不能确认M4，因为M4是收到的失序报文段。根据可靠传输原理，接收方可以什么都不做，也可以在适当时机发送一次对M2的确认。但按照快重传算法的规定，接收方应及时发送对M2的重复确认，这样做可以让发送方及早知道报文段M3没有到达接收方。发送方接着发送了M5和M6。接收方收到这两个报文后，也还要再次发出对M2的重复确认。这样，发送方共收到了接收方的四个对M2的确认，其中后三个都是重复确认。

根据快重传算法的规定，发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段M3，而不必继续等待M3设置的重传计时器到期。

## 8、快恢复算法

与快重传算法一同执行的，是快恢复。其中的过程包括：

<1>. 当发送方连续收到三个重复确认，就执行“乘法减小”算法，把慢开始门限ssthresh减半。这是为了预防网络发生拥塞。请注意：接下去不执行慢开始算法。

<2>. 由于发送方现在认为网络很可能没有发生拥塞，因此与慢开始不同之处是现在不执行慢开始算法（即拥塞窗口cwnd现在不设置为1）。

<3>.**快恢复算法：**而是把cwnd值设置为慢开始门限ssthresh减半后的数值，然后开始执行拥塞避免算法（“加法增大”），使拥塞窗口缓慢地线性增大。

下图给出了快重传和快恢复的示意图，并标明了“TCP Reno版本”。

区别：新的 TCP Reno 版本在快重传之后采用快恢复算法而不是采用慢开始算法。

![img](https://img-blog.csdn.net/20140509221048265?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWVjaGFvZGVjaHVudGlhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

也有的快重传实现是把开始时的拥塞窗口cwnd值再增大一点，即等于 ssthresh + 3 X MSS 。这样做的理由是：既然发送方收到三个重复的确认，就表明有三个分组已经离开了网络。这三个分组不再消耗网络 的资源而是停留在接收方的缓存中。可见现在网络中并不是堆积了分组而是减少了三个分组。因此可以适当把拥塞窗口扩大了些。

在采用快恢复算法时，慢开始算法只是在TCP连接建立时和网络出现超时时才使用。



## 9、发送窗口设置

接收方根据自己的接收能力设定了接收窗口rwnd，并把这个窗口值写入TCP首部中的窗口字段，传送给发送方。因此，接收窗口又称为通知窗口。因此，从接收方对发送方的流量控制的角度考虑，发送方的发送窗口一定不能超过对方给出的接收窗口rwnd 。

发送方窗口的上限值 = Min [ rwnd, cwnd ]

当rwnd < cwnd 时，是接收方的接收能力限制发送方窗口的最大值。

当cwnd < rwnd 时，则是网络的拥塞限制发送方窗口的最大值。



## 10、参考

https://blog.csdn.net/liaoqianwen123/article/details/25429143

https://www.jianshu.com/p/97e5d7e73ba0
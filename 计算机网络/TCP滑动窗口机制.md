# TCP滑动窗口机制

TCP协议为了实现客户端和服务端的稳定传输，有相应的机制处理网络传输过程中的丢包问题，比如滑动窗口、超时重传、累计ACK等。

滑动窗口机制，是一种控制TCP数据传输的流量的方法。通过窗口限制发送方的数据包数量和大小，达到流量控制避免丢包的作用。

## 1、滑动窗口的基础

1、当客户端和服务端建立连接后，双方可以开始数据传输。具体过程是客户端向服务端发包message，服务端对每个包返回ack确认消息。但是不时会有数据包丢失。

![img](https://img-blog.csdn.net/20160905224437961)

2、服务端的接收数据能力是有限的，具体单位是字节。例如下图中序号175消息，服务端计算缓冲区只能容纳384字节，那就发送消息让客户端最多发送384个字节的数据包。

等到服务端处理完成缓冲区中的数据包，再将空余的窗口告知客户端继续发送新的数据包。

![1586594932352](C:\Users\wonde\AppData\Roaming\Typora\typora-user-images\1586594932352.png)



## 2、TCP设置滑动窗口

了解到服务端和客户端有窗口后，那滑动窗口的定义就是：通过窗口发送的连续不同数据包。



### 2.1 发送窗口

在客户端也就是发送端，现在假设我们有上百个连续数据包等待发送，我们可以将这些数据包做个分类：

![img](https://img-blog.csdn.net/20160906072310877)

1. **Sent and Acknowledged：**

   这些数据表示已经发送成功并已经被确认的数据，比如图中的前31个bytes，这些数据其实的位置是在窗口之外了，因为窗口内顺序最低的被确认之后，要移除窗口，实际上是窗口进行合拢，同时打开接收新的带发送的数据

2. **Send But Not Yet Acknowledged：**

   这部分数据称为发送但没有被确认，数据被发送出去，没有收到接收端的ACK，认为并没有完成发送，这个属于窗口内的数据。

3. **Not Sent，Recipient Ready to Receive：**

   这部分是尽快发送的数据，这部分数据已经被加载到缓存中，也就是窗口中了，等待发送，其实这个窗口是完全有接收方告知的，接收方告知还是能够接受这些包，所以发送方需要尽快的发送这些包

4. **Not Sent，Recipient Not Ready to Receive：**

  这些数据属于未发送，同时接收端也不允许发送的，因为这些数据已经超出了发送端所接收的范围

这里将“滑动窗口”理解为第二类数据包，已发送但还未收到确认。等待当前窗口中的数据包被ack消息确认后，就继续发送排在后面的数据包，第三类数据包转移到第二类中，实现窗口”滑动“的效果。

![img](https://img-blog.csdn.net/20160906084353705)



### 2.2 接收窗口

对于接收端也是有一个接收窗口的，类似发送端，接收端的数据有3个分类，因为接收端并不需要等待ACK所以它没有类似的接收并确认了的分类，情况如下

1.  Received and ACK Not Send to Process：这部分数据属于接收了数据但是还没有被上层的应用程序接收，也是被缓存在窗口内
2.  Received  Not ACK: 已经接收并，但是还没有回复ACK，这些包可能输属于Delay ACK的范畴了
3.  Not Received：有空位，还没有被接收的数据。



## 3、参考

https://blog.csdn.net/wdscq1234/article/details/52444277

https://blog.csdn.net/yao5hed/article/details/81046945
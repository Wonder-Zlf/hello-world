# 线程安全与synchronized关键字

## 1、synchronized关键字

常用于控制线程同步中，保证线程安全。在同类方法中，例如stringbuffer和stringbuilder，string buffer类中的每个方法都加了sychronized关键字。相应地，性能下降20%。

原理：synchronized 关键字声明的方法同一时间只能被一个线程访问。



## 2、线程安全

线程安全就是多线程访问时，采用了加锁机制，当一个线程访问该类的某个数据时，进行保护。加锁时不能进行访问直到该线程读取完成，其他线程才可使用。不会出现数据不一致或者数据污染。

线程不安全就是不提供数据访问保护，有可能出现多个线程先后更改数据造成脏数据。



## 3、synchronized实现线程安全

创建一个对象A，A的方法methodA定义时加了synchronized。线程1在访问A的methodA时，其他线程调用methodA会互斥，从而达到保护作用。

使用synchronized修饰的方法或者代码块可以看作是一个原子操作，要么执行完成要么不执行，不可拆分不会有分支。

每个锁对象(JLS(java语言规范)中叫monitor)都有两个队列，一个是就绪队列，一个是阻塞队列，就绪队列存储了将要获得锁的线程，阻塞队列存储了被阻塞的线程，当一个线程被唤醒(notify)后，才会进入到就绪队列，等待CPU的调度，反之，当一个线程被wait后，就会进入阻塞队列，等待下一次被唤醒，这个涉及到线程间的通信。



## 4、volatile关键字

volatile不用于控制线程安全，只是保证线程间通信总能得到一个变量的最新数据。

volatile 修饰的成员变量在每次被线程访问时，都强制从共享内存中重新读取该成员变量的值。而且，当成员变量发生变化时，会强制线程将变化值回写到共享内存。这样在任何时刻，两个不同的线程总是看到某个成员变量的同一个值。